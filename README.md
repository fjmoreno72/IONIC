# IOCore2 Coverage Analysis Tool

A Flask-based web application for analyzing IOCore2 coverage data.

## Project Structure

The application follows a standard Flask application factory pattern:

```
/
├── app/                  # Main Flask application package
│   ├── __init__.py       # Application factory (create_app)
│   ├── api/              # API client implementation (iocore2.py, client.py)
│   ├── config/           # Configuration (settings.py)
│   ├── core/             # Core logic (auth.py, exceptions.py)
│   ├── data_models/      # Data analysis/modeling (ier_analysis.py, sreq_analysis.py, models.py)
│   ├── routes/           # Flask Blueprints for different sections
│   │   ├── __init__.py
│   │   ├── api.py        # API endpoints
│   │   ├── auth.py       # Authentication routes
│   │   ├── config_items.py # Config Item CRUD routes
│   │   └── views.py      # Main page view routes
│   ├── static/           # Static assets (CSS, JS, images, icons, fonts)
│   │   ├── css/
│   │   ├── js/
│   │   ├── img/
│   │   ├── favicon/
│   │   └── ASC/          # Specific assets for ASC module
│   ├── templates/        # Jinja2 templates
│   │   ├── components/
│   │   └── pages/
│   └── utils/            # Utility functions (file_operations.py, logging.py)
├── data/                 # Data files read/written by the app (JSON, CSV, MD, logs)
├── docs/                 # Project documentation
├── tools/                # Utility scripts
├── migrations/           # Database migrations (if applicable)
├── tests/                # Unit/integration tests (if applicable)
├── .env                  # Environment variables (optional, for local dev)
├── .flaskenv             # Flask environment variables (optional)
├── config.py             # WSGI entry point configuration (if needed)
├── requirements.txt      # Python dependencies
├── run.py                # Script to run the development server
└── README.md             # This file
```

**Key Components:**

* **`app/`**: The main Python package containing all application code.
* **`app/__init__.py`**: Defines the `create_app` factory function.
* **`app/routes/`**: Contains Flask Blueprints to organize routes logically.
* **`app/static/`**: Holds all static files served directly to the browser (CSS, JS, images).
* **`app/templates/`**: Contains Jinja2 HTML templates.
* **`data/`**: Stores data files used or generated by the application (e.g., `SREQ.json`, `IER.json`, `actors.json`, `pattern.json`, logs). **Note:** ASC-specific data files (`affiliates.json`, `sps.json`, etc.) remain within `app/static/ASC/data/` as they seem tightly coupled with the ASC frontend components.
* **`run.py`**: The primary script to start the Flask development server.

## Running the Application

### Environment Variables

The application can be configured using environment variables (or a `.env` / `.flaskenv` file):

* `IONIC2_SECRET_KEY`: Secret key for Flask sessions (default: "your-secret-key-here"). **Important:** Change this for production.
* `IONIC2_DEFAULT_URL`: Default URL for the target IOCore2 API (default: "<https://iocore2-ciav.ivv.ncia.nato.int>").
* `IONIC2_DEBUG`: Enable Flask debug mode ("True" or "False", default: "False").
* `IONIC2_LOG_LEVEL`: Logging level (e.g., "INFO", "DEBUG", default: "INFO").
* `IONIC2_PORT`: Port to run the application on (default: 5005).
* `IONIC2_HOST`: Host to bind the application to (default: "0.0.0.0").
* `FLASK_APP`: Should be set to `run:app` or detected automatically by Flask.

### Setup (Recommended)

1. **Create a virtual environment:**

    ```bash
    python -m venv .venv
    source .venv/bin/activate  # On Windows use `.venv\Scripts\activate`
    ```

2. **Install dependencies:**

    ```bash
    pip install -r requirements.txt
    ```

### Starting the Development Server

```bash
python run.py
```

The application should be accessible at `http://localhost:5005` (or the configured host/port).

## Production Deployment (Gunicorn + systemd)

For production, use a WSGI server like Gunicorn managed by systemd.

**Example `/etc/systemd/system/ionic-app.service`:**

```ini
[Unit]
Description=Gunicorn instance to serve IONIC2 application
After=network.target

[Service]
User=root # Or a dedicated user
Group=www-data # Or a dedicated group
WorkingDirectory=/home/iocore/IONIC2 # CHANGE TO YOUR PROJECT PATH
# Ensure the virtual environment path is correct for your server
Environment="PATH=/home/iocore/IONIC2/venv/bin" # CHANGE TO YOUR VENV PATH
# ExecStart points to 'app:create_app()' in the app package
ExecStart=/home/iocore/IONIC2/venv/bin/gunicorn --workers 4 --timeout 600 --keep-alive 600 --bind 0.0.0.0:5005 'app:create_app()' # CHANGE PATHS

[Install]
WantedBy=multi-user.target
```

**Steps to Apply Service Changes:**

1. **Edit the service file:**

    ```bash
    sudo nano /etc/systemd/system/ionic-app.service
    ```

    *(Update paths and ensure the `ExecStart` line uses `'app:create_app()'`).*
2. **Stop the service:**

    ```bash
    sudo systemctl stop ionic-app.service
    ```

3. **Reload systemd:**

    ```bash
    sudo systemctl daemon-reload
    ```

4. **Start the service:**

    ```bash
    sudo systemctl start ionic-app.service
    ```

5. **Check status:**

    ```bash
    sudo systemctl status ionic-app.service
    ```

**Nginx Configuration:**

Ensure your Nginx configuration (e.g., `/etc/nginx/sites-available/your-site`) correctly proxies requests to the Gunicorn server (e.g., `proxy_pass http://localhost:5005;`). It's also highly recommended to configure Nginx to serve static files directly from `/path/to/your/project/IONIC2/app/static` for better performance.

## Analysis of Next Steps / Potential Issues

Based on the reorganization and observed behavior:

1. **ASC Data Location:** The data files for the ASC module (`affiliates.json`, `sps.json`, `configItem.json`, etc.) are currently within `app/static/ASC/data/`. This works because both the Python backend (via `current_app.static_folder`) and potentially frontend JavaScript can access them relative to the static path. However, conceptually, data files often reside outside the static folder unless directly served. **Decision:** Keep as is for now, but consider moving them to the top-level `data/` directory if frontend JS doesn't directly fetch them (requiring API endpoints for all CRUD operations).
2. **Hardcoded Paths in JS/CSS/HTML:** While Python imports and paths were updated, there might be hardcoded paths within JavaScript, CSS (`url(...)`), or HTML templates that were missed and could cause issues (though the recent tests seem okay). A thorough review or testing of all features is recommended.
3. **`requirements.txt`:** Ensure the root `requirements.txt` is complete and accurate for the refactored application. The one moved from `ionic2/` might be redundant or incomplete.
4. **Database (`migrate.py`, `app/data_models/models.py`):** The presence of `migrate.py` and `models.py` suggests database usage (likely SQLAlchemy with Flask-Migrate/Alembic). The database connection strings and migration setup might need verification within the new structure (`app/config/settings.py`, `app/__init__.py`).
5. **Testing:** Add unit and integration tests to verify functionality after the refactor and prevent regressions.
6. **Deployment (`DEPLOYMENT.md`, `config.py`):** The deployment documentation (`docs/DEPLOYMENT.md`, `DEPLOYMENT.md` at root) needs updating. A `config.py` or `wsgi.py` might be needed for production WSGI servers like Gunicorn or uWSGI.
