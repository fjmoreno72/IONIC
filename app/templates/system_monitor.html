<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Resource Monitor</title>
    {% include 'components/head_favicons.html' %}
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fontawesome.min.css') }}">
    <style>
        :root {
            --primary-color: #003366;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1e293b;
            --border-color: #e2e8f0;
        }

        [data-theme="dark"] {
            --primary-color: #3399ff;
            --background-color: #0f172a;
            --card-background: #1e293b;
            --text-primary: #f1f5f9;
            --border-color: #334155;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            margin: 0;
            transition: background-color 0.2s ease;
            background-image: radial-gradient(circle at 1px 1px, rgba(0, 0, 0, 0.05) 1px, transparent 0);
            background-size: 25px 25px;
        }

        [data-theme="dark"] body {
            background-image: radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.05) 1px, transparent 0);
        }

        .container-fluid {
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .header h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
            color: var(--primary-color);
        }
        
        .header h1 i {
            font-size: 0.9em;
        }
        
        .header-subtitle {
            font-size: 0.9em;
            color: #64748b;
            margin-top: -15px;
            margin-bottom: 15px;
        }
        
        [data-theme="dark"] .header-subtitle {
            color: #94a3b8;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px; /* Slightly larger padding */
            text-align: center;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .metric-card:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        /* Status indicator */
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: var(--border-color);
            transition: background-color 0.3s ease;
        }
        
        /* Low value indicator (red) */
        .metric-card.status-critical::before {
            background-color: #ef4444;
        }
        
        /* Medium value indicator (amber) */
        .metric-card.status-warning::before {
            background-color: #f59e0b;
        }
        
        /* Good value indicator (green) */
        .metric-card.status-good::before {
            background-color: #22c55e;
        }

        .metric-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1em; /* Slightly larger title */
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .metric-card .icon {
            font-size: 1.2em;
            color: var(--primary-color);
        }

        .metric-value {
            font-size: 1.8em; /* Larger value */
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        .metric-unit {
            font-size: 0.8em;
            color: #64748b; /* Secondary text color */
        }
        [data-theme="dark"] .metric-unit {
            color: #94a3b8;
        }

        .metric-percentage-bar {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .percentage-fill {
            height: 100%;
            width: 0%; /* Will be set by JavaScript */
            border-radius: 4px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .metric-percentage-text {
            font-size: 0.8em;
            color: #64748b;
            margin-top: 4px;
        }

        [data-theme="dark"] .metric-percentage-text {
            color: #94a3b8;
        }

        [data-theme="dark"] .metric-percentage-bar {
            background-color: #334155;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            width: 100%;
            overflow: hidden;
        }

        .response-time-chart {
            width: 100%;
            margin-top: 20px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .chart-container {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            height: 280px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.2s ease;
            overflow: hidden;
            min-width: 0; /* Allow grid items to shrink below content size */
        }

        .chart-container canvas {
            max-width: 100% !important;
            height: auto !important;
        }
        
        .chart-container:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Chart expand button */
        .chart-expand-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            z-index: 2;
        }

        .chart-expand-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .chart-expand-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Modal overlay for expanded chart */
        .chart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .chart-modal.active {
            display: flex;
        }

        .chart-modal-content {
            background-color: var(--card-background);
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: none;
            max-height: 90vh;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .chart-modal-close {
            position: absolute;
            bottom: 40px;
            left: 40px;
            background: var(--primary-color);
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1.2em;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .chart-modal-close:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        .chart-modal-close i {
            font-size: 1.1em;
        }

        .chart-modal-close .close-text {
            font-size: 0.9em;
        }

        .chart-modal-title {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 1.2em;
            font-weight: 600;
            padding-right: 100px; /* Make space for the close button */
        }

        .chart-modal-chart {
            width: 100%;
            height: calc(90vh - 100px);
            min-height: 400px;
        }

        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, background-color 0.3s ease;
            z-index: 100;
        }
        
        .theme-toggle:hover {
            transform: rotate(30deg);
        }
        
        .last-updated {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        [data-theme="dark"] .last-updated {
            color: #94a3b8;
        }
        
        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: repeat(2, 1fr); /* 2 columns on medium screens */
                gap: 15px;
            }
            
            .chart-container {
                height: 250px;
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            .container-fluid {
                padding: 10px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr; /* 1 column on mobile */
                gap: 15px;
            }
            
            .chart-container {
                height: 220px;
                padding: 15px;
            }
            
            .metric-card {
                padding: 15px;
            }
            
            .metric-value {
                font-size: 1.5em;
            }
            
            h1 {
                font-size: 1.5em;
            }

            .chart-modal-content {
                width: 95%;
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .charts-grid {
                gap: 10px;
            }
            
            .chart-container {
                height: 200px;
                padding: 10px;
            }
            
            .container-fluid {
                padding: 5px;
            }
        }

        /* Logo in header */
        .header-logo {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 1.8em;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Heartbeat animation for the heart icon */
        @keyframes heartbeat {
            0% { transform: scale(1); }
            15% { transform: scale(1.25); }
            30% { transform: scale(1); }
            45% { transform: scale(1.25); }
            60% { transform: scale(1); }
            100% { transform: scale(1); }
        }
        
        .heartbeat-icon {
            display: inline-block;
            color: #e74c3c; /* Red heart color */
            transform-origin: center;
            animation: heartbeat 1.5s ease infinite;
        }
        
        [data-theme="dark"] .heartbeat-icon {
            color: #ff6b6b; /* Lighter red for dark mode */
        }

        .metric-status {
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px 0;
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
        }

        .metric-status.healthy {
            background-color: #22c55e;
            color: white;
        }

        .metric-status.unhealthy {
            background-color: #ef4444;
            color: white;
        }

        .metric-status.degraded {
            background-color: #f59e0b;
            color: white;
        }

        .metric-description {
            font-size: 0.9em;
            color: #64748b;
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        [data-theme="dark"] .metric-description {
            color: #94a3b8;
            background-color: rgba(255, 255, 255, 0.05);
        }

        .metric-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .detail-value {
            font-family: monospace;
            color: var(--primary-color);
        }

        /* Add to CSS for .chart-row if not present */
        /*
        .chart-row {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        */
    </style>
</head>
<body class="logged-in">
    {% include 'nav_menu.html' %}
    <div class="container-fluid px-4">
        <div class="header-logo">
            <i class="fas fa-server"></i> <span>SysMonitor</span>
        </div>
        <div class="header">
            <!-- Use the server_url variable passed from Flask -->
            <h1><i class="fas fa-heartbeat heartbeat-icon"></i> {{ server_url | replace('https://', '') | replace('http://', '') }} - System Health Monitor</h1>
            <div class="last-updated" id="lastUpdated"><i class="fas fa-sync-alt"></i> Last updated: Never</div>
            <div id="errorMessage" class="error-message"></div>
        </div>

        <!-- Charts: two columns layout -->
        <div class="charts-grid">
            <!-- First row -->
            <div class="chart-container">
                <button class="chart-expand-btn" onclick="expandChart('siteResourcesChart', 'Site Resources')">
                    <i class="fas fa-microchip icon"></i> <span>Expand</span>
                </button>
                <canvas id="cpuSqlChart"></canvas>
            </div>
            <div class="chart-container">
                <button class="chart-expand-btn" onclick="expandChart('serverResourcesChart', 'Server Resources')">
                    <i class="fas fa-server icon"></i> <span>Expand</span>
                </button>
                <canvas id="memoryHostChart"></canvas>
            </div>
            <!-- Second row -->
            <div class="chart-container">
                <button class="chart-expand-btn" onclick="expandChart('activeCircuitsChart', 'Active Circuits')">
                    <i class="fas fa-project-diagram icon"></i> <span>Expand</span>
                </button>
                <canvas id="activeCircuitsChart"></canvas>
            </div>
            <div class="chart-container">
                <button class="chart-expand-btn" onclick="expandChart('dbConnectionChart', 'Database Connection')">
                    <i class="fas fa-database icon"></i> <span>Expand</span>
                </button>
                <canvas id="cpuHostChart"></canvas>
            </div>
        </div>

        <!-- API Response Time Chart -->
        <div class="response-time-chart">
            <div class="chart-container" style="height: 200px;">
                <button class="chart-expand-btn" onclick="expandChart('responseTimeChart', 'API Response Time')">
                    <i class="fas fa-clock icon"></i> <span>Expand</span>
                </button>
                <canvas id="responseTimeChart"></canvas>
            </div>
        </div>

        <!-- First row of metrics: Database Connection, Site Resources, Server Resources -->
        <div class="metrics-grid" style="margin-bottom: 30px;">
            <!-- Database Connection Section -->
            <div class="metric-card">
                <h3><i class="fas fa-database icon"></i> Database Connection</h3>
                <div class="metric-status" id="databaseStatus">--</div>
                <div class="metric-description" id="databaseDescription">--</div>
                <div class="metric-details">
                    <div class="detail-item">
                        <span class="detail-label">Host Memory:</span>
                        <span class="detail-value" id="hostMemory">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">SQL Memory:</span>
                        <span class="detail-value" id="sqlMemory">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Host CPU:</span>
                        <span class="detail-value" id="hostCpu">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">SQL CPU:</span>
                        <span class="detail-value" id="sqlCpu">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Duration:</span>
                        <span class="detail-value" id="databaseDuration">--</span>
                    </div>
                </div>
            </div>
            <!-- Site Resource Utilization Section -->
            <div class="metric-card">
                <h3><i class="fas fa-microchip icon"></i> Site Resources</h3>
                <div class="metric-status" id="siteResourcesStatus">--</div>
                <div class="metric-description" id="siteResourcesDescription">--</div>
                <div class="metric-details">
                    <div class="detail-item">
                        <span class="detail-label">Process CPU Utilization:</span>
                        <span class="detail-value" id="processCpuUtilization">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Virtual Memory Utilization:</span>
                        <span class="detail-value" id="virtualMemoryUtilization">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Active Circuits:</span>
                        <span class="detail-value" id="activeCircuits">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Max Concurrent Circuits:</span>
                        <span class="detail-value" id="maxConcurrentCircuits">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Duration:</span>
                        <span class="detail-value" id="siteResourcesDuration">--</span>
                    </div>
                </div>
            </div>
            <!-- Server Resource Utilization Section -->
            <div class="metric-card">
                <h3><i class="fas fa-server icon"></i> Server Resources</h3>
                <div class="metric-status" id="serverResourcesStatus">--</div>
                <div class="metric-description" id="serverResourcesDescription">--</div>
                <div class="metric-details">
                    <div class="detail-item">
                        <span class="detail-label">Processor Time:</span>
                        <span class="detail-value" id="processorTime">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Processor Time (raw):</span>
                        <span class="detail-value" id="processorTimeRaw">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Available Memory:</span>
                        <span class="detail-value" id="availableMemory">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Duration:</span>
                        <span class="detail-value" id="serverResourcesDuration">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second row of metrics: Site Certificate, Server Drives, Quartz Scheduler -->
        <div class="metrics-grid">
            <!-- Site Certificate Section -->
            <div class="metric-card">
                <h3><i class="fas fa-certificate icon"></i> Site Certificate</h3>
                <div class="metric-status" id="siteCertificateStatus">--</div>
                <div class="metric-description" id="siteCertificateDescription">--</div>
                <div class="metric-details">
                    <div class="detail-item">
                        <span class="detail-label">Expiration Date:</span>
                        <span class="detail-value" id="certificateExpiration">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Duration:</span>
                        <span class="detail-value" id="certificateDuration">--</span>
                    </div>
                </div>
            </div>
            <!-- Server Drives Section -->
            <div class="metric-card">
                <h3><i class="fas fa-hdd icon"></i> Server Drives</h3>
                <div class="metric-status" id="drivesStatus">--</div>
                <div class="metric-description" id="drivesDescription">--</div>
                <div class="metric-details">
                    <div class="detail-item">
                        <span class="detail-label">C: Drive:</span>
                        <span class="detail-value" id="driveC">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">D: Drive:</span>
                        <span class="detail-value" id="driveD">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">E: Drive:</span>
                        <span class="detail-value" id="driveE">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">F: Drive:</span>
                        <span class="detail-value" id="driveF">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Duration:</span>
                        <span class="detail-value" id="drivesDuration">--</span>
                    </div>
                </div>
            </div>
            <!-- Quartz Scheduler Section -->
            <div class="metric-card">
                <h3><i class="fas fa-clock icon"></i> Quartz Scheduler</h3>
                <div class="metric-status" id="schedulerStatus">--</div>
                <div class="metric-description" id="schedulerDescription">--</div>
                <div class="metric-details">
                    <div class="detail-item">
                        <span class="detail-label">Duration:</span>
                        <span class="detail-value" id="schedulerDuration">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for expanded chart -->
    <div id="chartModal" class="chart-modal">
        <div class="chart-modal-content">
            <button class="chart-modal-close" onclick="closeChartModal()">
                <i class="fas fa-compress"></i>
                <span class="close-text">Minimize</span>
            </button>
            <h3 class="chart-modal-title" id="modalChartTitle"></h3>
            <div class="chart-modal-chart">
                <canvas id="modalChart"></canvas>
            </div>
        </div>
    </div>

    <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>

    <script>
        const MAX_DATA_POINTS = 360; // Store 360 minutes (6 hours) of data
        const POLLING_INTERVAL = 60000; // 60 seconds
        const TOTAL_MEMORY_MB = 64000; // Total memory in MB - configure as needed

        // Global charts object to store all chart instances
        const charts = {};

        // Chart Colors
        const chartColors = {
            light: {
                hostMemory: '#3498db',
                sqlMemory: '#9b59b6',
                hostCpu: '#e67e22',
                sqlCpu: '#e74c3c',
                processCpu: '#2ecc71',
                processMemory: '#f1c40f',
                processorTime: '#1abc9c',
                availableMemory: '#34495e',
                activeCircuits: '#8b5cf6'
            },
            dark: {
                hostMemory: '#74b9ff',
                sqlMemory: '#a29bfe',
                hostCpu: '#fdcb6e',
                sqlCpu: '#ff7675',
                processCpu: '#00b894',
                processMemory: '#ffeaa7',
                processorTime: '#00cec9',
                availableMemory: '#636e72',
                activeCircuits: '#a78bfa'
            }
        };

        // Get current theme
        function getCurrentTheme() {
            return document.documentElement.getAttribute('data-theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        }

        const currentTheme = getCurrentTheme();
        const colors = chartColors[currentTheme];
        const sharedLabels = []; // Shared array for timestamps across all charts

        // Helper function to create chart configuration
        function createChartConfig(label, borderColor, yAxisLabel, min = 0, max = undefined) {
            return {
                type: 'line',
                data: {
                    labels: sharedLabels,
                    datasets: [{
                        label: label,
                        borderColor: borderColor,
                        data: [],
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: false
                            },
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: yAxisLabel
                            },
                            min: min,
                            max: max,
                            beginAtZero: true,
                            grid: {
                                color: currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: label,
                            padding: {
                                top: 10,
                                bottom: 10
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2);
                                        if (yAxisLabel.includes('%')) label += '%';
                                        if (yAxisLabel.includes('MB')) label += ' MB';
                                        if (yAxisLabel.includes('ms')) label += ' ms';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            };
        }

        // Initialize Charts
        charts.dbConnectionChart = new Chart(
            document.getElementById('cpuHostChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: sharedLabels,
                    datasets: [
                        {
                            label: 'Host Memory (MB)',
                            borderColor: colors.hostMemory,
                            data: [],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y-mem',
                        },
                        {
                            label: 'SQL Memory (MB)',
                            borderColor: colors.sqlMemory,
                            data: [],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y-mem',
                        },
                        {
                            label: 'Host CPU (%)',
                            borderColor: colors.hostCpu,
                            data: [],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y-cpu',
                        },
                        {
                            label: 'SQL CPU (%)',
                            borderColor: colors.sqlCpu,
                            data: [],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y-cpu',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: false },
                            ticks: { autoSkip: true, maxTicksLimit: 10 }
                        },
                        'y-mem': {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Memory (MB)' },
                            beginAtZero: true,
                            grid: { color: currentTheme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                        },
                        'y-cpu': {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'CPU (%)' },
                            min: 0,
                            max: 100,
                            beginAtZero: true,
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: true, text: 'Database Connection', padding: { top: 10, bottom: 10 } },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            }
        );
        charts.siteResourcesChart = new Chart(
            document.getElementById('cpuSqlChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: sharedLabels,
                    datasets: [
                        {
                            label: 'Process CPU Utilization (%)',
                            borderColor: colors.processCpu,
                            data: [],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y-cpu'
                        },
                        {
                            label: 'Virtual Memory Utilization (%)',
                            borderColor: colors.processMemory,
                            data: [],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y-memory'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: false },
                            ticks: { autoSkip: true, maxTicksLimit: 10 }
                        },
                        'y-memory': {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Memory (%)' },
                            min: 0,
                            max: 100,
                            beginAtZero: true,
                            grid: { color: currentTheme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                        },
                        'y-cpu': {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'CPU (%)' },
                            min: 0,
                            beginAtZero: true,
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: true, text: 'Site Resources', padding: { top: 10, bottom: 10 } },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            }
        );
        charts.serverResourcesChart = new Chart(
            document.getElementById('memoryHostChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: sharedLabels,
                    datasets: [
                        {
                            label: 'Processor Time (%)',
                            borderColor: colors.processorTime,
                            data: [],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y-proc'
                        },
                        {
                            label: 'Available Memory (MB)',
                            borderColor: colors.availableMemory,
                            data: [],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y-mem'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: false },
                            ticks: { autoSkip: true, maxTicksLimit: 10 }
                        },
                        'y-mem': {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Available Memory (MB)' },
                            beginAtZero: true,
                            grid: { color: currentTheme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                        },
                        'y-proc': {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Processor Time (%)' },
                            min: 0,
                            max: 100,
                            beginAtZero: true,
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: true, text: 'Server Resources', padding: { top: 10, bottom: 10 } },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            }
        );

        // Initialize Active Circuits Chart
        charts.activeCircuitsChart = new Chart(
            document.getElementById('activeCircuitsChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: sharedLabels,
                    datasets: [
                        {
                            label: 'Active Circuits',
                            borderColor: colors.activeCircuits,
                            data: [],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: false },
                            ticks: { autoSkip: true, maxTicksLimit: 10 }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Circuit Count' },
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            },
                            grid: { color: currentTheme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: true, text: 'Active Circuits', padding: { top: 10, bottom: 10 } },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += Math.round(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            }
        );

        // Initialize Response Time Chart
        charts.responseTimeChart = new Chart(
            document.getElementById('responseTimeChart').getContext('2d'),
            {
                type: 'line',
                data: {
                    labels: sharedLabels,
                    datasets: [
                        {
                            label: 'Response Time',
                            borderColor: '#10b981',
                            data: [],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            display: true,
                            title: { display: false },
                            ticks: { autoSkip: true, maxTicksLimit: 10 }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Response Time (ms)' },
                            beginAtZero: true,
                            grid: { color: currentTheme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: true, text: 'API Response Time', padding: { top: 10, bottom: 10 } },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' ms';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            }
        );

        const allCharts = [
            charts.dbConnectionChart,
            charts.siteResourcesChart,
            charts.serverResourcesChart,
            charts.activeCircuitsChart,
            charts.responseTimeChart
        ];

        // Document ready function
        document.addEventListener('DOMContentLoaded', function() {
            // Verify all required elements exist
            const requiredElements = [
                'lastUpdated',
                'errorMessage',
                'siteCertificateStatus',
                'siteCertificateDescription',
                'certificateExpiration',
                'certificateDuration',
                'databaseStatus',
                'databaseDescription',
                'hostMemory',
                'sqlMemory',
                'hostCpu',
                'sqlCpu',
                'databaseDuration',
                'drivesStatus',
                'drivesDescription',
                'driveC',
                'driveD',
                'driveE',
                'driveF',
                'drivesDuration',
                'siteResourcesStatus',
                'siteResourcesDescription',
                'processCpuUtilization',
                'virtualMemoryUtilization',
                'activeCircuits',
                'maxConcurrentCircuits',
                'siteResourcesDuration',
                'serverResourcesStatus',
                'serverResourcesDescription',
                'processorTime',
                'processorTimeRaw',
                'availableMemory',
                'serverResourcesDuration',
                'schedulerStatus',
                'schedulerDescription',
                'schedulerDuration'
            ];

            // Check if all elements exist
            const missingElements = requiredElements.filter(id => !document.getElementById(id));
            if (missingElements.length > 0) {
                console.error('Missing required elements:', missingElements);
                const errorDiv = document.getElementById('errorMessage');
                if (errorDiv) {
                    errorDiv.textContent = `Error: Missing required elements: ${missingElements.join(', ')}`;
                    errorDiv.style.display = 'block';
                }
                return;
            }

            // Initialize all elements with default values
            const statusElements = document.querySelectorAll('.metric-status');
            statusElements.forEach(el => {
                el.textContent = '--';
                el.className = 'metric-status';
            });

            const descriptionElements = document.querySelectorAll('.metric-description');
            descriptionElements.forEach(el => el.textContent = '--');

            const detailElements = document.querySelectorAll('.detail-value');
            detailElements.forEach(el => el.textContent = '--');

            // Initial fetch and start polling
            updateMetrics();
            setInterval(updateMetrics, POLLING_INTERVAL); // Poll every 60 seconds
        });

        // Function to safely update element content
        function safeUpdateElement(id, content, className = null) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id '${id}' not found`);
                return;
            }
            if (content !== undefined && content !== null) {
                element.textContent = content;
            }
            if (className) {
                element.className = className;
            }
        }

        // Function to update metrics and chart
        async function updateMetrics() {
            const errorDiv = document.getElementById('errorMessage');
            const lastUpdatedElement = document.getElementById('lastUpdated');
            
            if (!errorDiv || !lastUpdatedElement) {
                console.error('Required elements not found');
                return;
            }

            try {
                lastUpdatedElement.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Updating...';
                
                // Start timing the API request
                const startTime = performance.now();
                
                const response = await fetch('/api/remote_system_health');
                // Calculate response time right after the fetch completes
                const endTime = performance.now();
                const responseTime = endTime - startTime;

                if (!response.ok) {
                    throw new Error(`Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                if (!data || !data.entries) {
                    throw new Error('Invalid data format received from API');
                }

                // Update shared labels first
                const timestamp = new Date().toLocaleTimeString();
                if (sharedLabels.length >= MAX_DATA_POINTS) sharedLabels.shift();
                sharedLabels.push(timestamp);

                // Update response time chart (after labels are updated)
                const responseTimeChart = charts.responseTimeChart.data.datasets[0];
                if (responseTimeChart.data.length >= MAX_DATA_POINTS) responseTimeChart.data.shift();
                responseTimeChart.data.push(responseTime);
                charts.responseTimeChart.update();

                // Update Site Certificate
                const certificateData = data.entries['site-certificate'];
                if (certificateData) {
                    safeUpdateElement('siteCertificateStatus', certificateData.status, `metric-status ${certificateData.status.toLowerCase()}`);
                    safeUpdateElement('siteCertificateDescription', certificateData.description);
                    safeUpdateElement('certificateExpiration', certificateData.data['Expiration date']);
                    safeUpdateElement('certificateDuration', certificateData.duration);
                }

                // Update Database Connection
                const dbData = data.entries['database-connection'];
                if (dbData) {
                    const hostMem = dbData.data.host_memory_availableMB || 0;
                    const sqlMem = dbData.data.sqlserver_memory_usedMB || 0;
                    const hostCpu = dbData.data.host_cpu_usedPct || 0;
                    const sqlCpu = dbData.data.sqlserver_cpu_usedPct || 0;

                    // Restore card updates
                    safeUpdateElement('databaseStatus', dbData.status, `metric-status ${dbData.status.toLowerCase()}`);
                    safeUpdateElement('databaseDescription', dbData.description);
                    safeUpdateElement('hostMemory', `${hostMem} MB`);
                    safeUpdateElement('sqlMemory', `${sqlMem} MB`);
                    safeUpdateElement('hostCpu', `${hostCpu}%`);
                    safeUpdateElement('sqlCpu', `${sqlCpu}%`);
                    safeUpdateElement('databaseDuration', dbData.duration);

                    const dbChart = charts.dbConnectionChart.data.datasets;
                    if (dbChart[0].data.length >= MAX_DATA_POINTS) dbChart[0].data.shift();
                    if (dbChart[1].data.length >= MAX_DATA_POINTS) dbChart[1].data.shift();
                    if (dbChart[2].data.length >= MAX_DATA_POINTS) dbChart[2].data.shift();
                    if (dbChart[3].data.length >= MAX_DATA_POINTS) dbChart[3].data.shift();
                    dbChart[0].data.push(hostMem);
                    dbChart[1].data.push(sqlMem);
                    dbChart[2].data.push(hostCpu);
                    dbChart[3].data.push(sqlCpu);
                    console.log('DB Host Memory:', hostMem, 'SQL Memory:', sqlMem, 'Host CPU:', hostCpu, 'SQL CPU:', sqlCpu);
                    console.log('DB Chart Datasets Lengths:', dbChart.map(ds => ds.data.length));
                    charts.dbConnectionChart.update();
                }

                // Update Server Drives
                const drivesData = data.entries['server-drives'];
                if (drivesData && drivesData.data && Array.isArray(drivesData.data.Summary)) {
                    safeUpdateElement('drivesStatus', drivesData.status, `metric-status ${drivesData.status.toLowerCase()}`);
                    safeUpdateElement('drivesDescription', drivesData.description);
                    
                    drivesData.data.Summary.forEach(drive => {
                        const driveId = drive.drive.replace(':\\', '').toUpperCase();
                        const usagePercent = ((drive.totalMb - drive.availableMb) / drive.totalMb * 100).toFixed(1);
                        safeUpdateElement(`drive${driveId}`, 
                            `${usagePercent}% (${drive.availableMb.toLocaleString()} MB available of ${drive.totalMb.toLocaleString()} MB)`);
                    });
                    safeUpdateElement('drivesDuration', drivesData.duration);
                }

                // Update Site Resource Utilization
                const siteResourcesData = data.entries['site-resource-utilization'];
                if (siteResourcesData) {
                    const processCpuUtilization = (siteResourcesData.data['process.cpu.utilization'] || 0) * 100;
                    const virtualMemoryUtilization = siteResourcesData.data['dotnet.process.memory.virtual.utilization'] || 0;
                    const activeCircuits = siteResourcesData.data['active.circuits'] || 0;
                    const maxConcurrentCircuits = siteResourcesData.data['max.concurrent.circuits'] || 0;

                    // Update card values
                    safeUpdateElement('siteResourcesStatus', siteResourcesData.status, `metric-status ${siteResourcesData.status.toLowerCase()}`);
                    safeUpdateElement('siteResourcesDescription', siteResourcesData.description);
                    safeUpdateElement('processCpuUtilization', `${processCpuUtilization.toFixed(2)}%`);
                    safeUpdateElement('virtualMemoryUtilization', `${virtualMemoryUtilization.toFixed(2)}%`);
                    safeUpdateElement('activeCircuits', activeCircuits);
                    safeUpdateElement('maxConcurrentCircuits', maxConcurrentCircuits);
                    safeUpdateElement('siteResourcesDuration', siteResourcesData.duration);

                    // Update chart data
                    const siteChart = charts.siteResourcesChart.data.datasets;
                    
                    // Shift old data if we exceed max points
                    if (siteChart[0].data.length >= MAX_DATA_POINTS) siteChart[0].data.shift();
                    if (siteChart[1].data.length >= MAX_DATA_POINTS) siteChart[1].data.shift();
                    
                    // Add new data points
                    siteChart[0].data.push(processCpuUtilization);          // Process CPU Utilization (%)
                    siteChart[1].data.push(virtualMemoryUtilization);       // Virtual Memory Utilization (%)
                    
                    console.log('Site Resources - CPU Util:', processCpuUtilization, 'VM Util:', virtualMemoryUtilization, 'Active Circuits:', activeCircuits);
                    console.log('Site Resources Datasets Lengths:', siteChart.map(ds => ds.data.length));
                    charts.siteResourcesChart.update();

                    // Update Active Circuits Chart with site resources data
                    const circuitsChart = charts.activeCircuitsChart.data.datasets[0];
                    if (circuitsChart.data.length >= MAX_DATA_POINTS) circuitsChart.data.shift();
                    circuitsChart.data.push(activeCircuits);
                    console.log('Site Active Circuits:', activeCircuits);
                    charts.activeCircuitsChart.update();
                }

                // Update Server Resource Utilization
                const serverResourcesData = data.entries['server-resource-utilization'];
                if (serverResourcesData) {
                    const processorTimeRaw = serverResourcesData.data['Processor/% Processor Time/_Total'] || 0;
                    const processorTime = processorTimeRaw;
                    const availableMemory = serverResourcesData.data['Memory/Available Mbytes'] || 0;
                    
                    // Get the new system resource values (if they exist here)
                    const systemProcessCpuUtilization = serverResourcesData.data['process.cpu.utilization'] || 0;
                    const systemVirtualMemoryUtilization = serverResourcesData.data['dotnet.process.memory.virtual.utilization'] || 0;
                    const systemActiveCircuits = serverResourcesData.data['active.circuits'] || 0;
                    const systemMaxConcurrentCircuits = serverResourcesData.data['max.concurrent.circuits'] || 0;

                    // Restore card updates
                    safeUpdateElement('serverResourcesStatus', serverResourcesData.status, `metric-status ${serverResourcesData.status.toLowerCase()}`);
                    safeUpdateElement('serverResourcesDescription', serverResourcesData.description);
                    safeUpdateElement('processorTime', `${processorTime.toFixed(2)}%`);
                    safeUpdateElement('processorTimeRaw', processorTimeRaw);
                    safeUpdateElement('availableMemory', `${availableMemory.toLocaleString()} MB`);
                    safeUpdateElement('serverResourcesDuration', serverResourcesData.duration);
                    
                    // Update the site resources card with system values if they exist in this section
                    // Only override with server resource values if they exist and are meaningful
                    if (systemProcessCpuUtilization > 0) {
                        safeUpdateElement('processCpuUtilization', `${(systemProcessCpuUtilization * 100).toFixed(2)}%`);
                    }
                    if (systemVirtualMemoryUtilization > 0) {
                        safeUpdateElement('virtualMemoryUtilization', `${systemVirtualMemoryUtilization.toFixed(2)}%`);
                    }
                    if (systemActiveCircuits > 0) {
                        safeUpdateElement('activeCircuits', systemActiveCircuits);
                        
                        // Only update Active Circuits Chart if we have system data for it and it differs from site data
                        const circuitsChart = charts.activeCircuitsChart.data.datasets[0];
                        // Replace the last data point with system data if it exists
                        if (circuitsChart.data.length > 0) {
                            circuitsChart.data[circuitsChart.data.length - 1] = systemActiveCircuits;
                        } else {
                            circuitsChart.data.push(systemActiveCircuits);
                        }
                        console.log('System Active Circuits (override):', systemActiveCircuits);
                        charts.activeCircuitsChart.update();
                    }
                    if (systemMaxConcurrentCircuits > 0) {
                        safeUpdateElement('maxConcurrentCircuits', systemMaxConcurrentCircuits);
                    }

                    const serverChart = charts.serverResourcesChart.data.datasets;
                    if (serverChart[0].data.length >= MAX_DATA_POINTS) serverChart[0].data.shift();
                    if (serverChart[1].data.length >= MAX_DATA_POINTS) serverChart[1].data.shift();
                    serverChart[0].data.push(processorTime);
                    serverChart[1].data.push(availableMemory);
                    console.log('Server Resources Processor Time:', processorTime, 'Available Memory:', availableMemory);
                    console.log('Server Resources Datasets Lengths:', serverChart.map(ds => ds.data.length));
                    charts.serverResourcesChart.update();
                }

                // Update Quartz Scheduler
                const schedulerData = data.entries['quartz-scheduler'];
                if (schedulerData) {
                    safeUpdateElement('schedulerStatus', schedulerData.status, `metric-status ${schedulerData.status.toLowerCase()}`);
                    safeUpdateElement('schedulerDescription', schedulerData.description);
                    safeUpdateElement('schedulerDuration', schedulerData.duration);
                }

                // Update last updated time
                lastUpdatedElement.innerHTML = `<i class="fas fa-check-circle" style="color: #22c55e;"></i> Last updated: ${new Date().toLocaleString()}`;
                errorDiv.style.display = 'none';

            } catch (error) {
                console.error('Error fetching remote system health:', error);
                errorDiv.textContent = `Failed to load system health data: ${error.message}`;
                errorDiv.style.display = 'block';
                lastUpdatedElement.innerHTML = `<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> Last updated: ${new Date().toLocaleString()} (with errors)`;
                
                // Clear all status indicators
                const statusElements = document.querySelectorAll('.metric-status');
                statusElements.forEach(el => {
                    el.textContent = '--';
                    el.className = 'metric-status';
                });

                // Clear all descriptions
                const descriptionElements = document.querySelectorAll('.metric-description');
                descriptionElements.forEach(el => el.textContent = '--');

                // Clear all detail values
                const detailElements = document.querySelectorAll('.detail-value');
                detailElements.forEach(el => el.textContent = '--');
            }
        }

        // Chart expansion functionality
        let modalChart = null;

        function expandChart(chartId, title) {
            const originalChart = charts[chartId];
            // Check if chart exists and has data
            if (!originalChart || !originalChart.data || !originalChart.data.labels) {
                console.error(`Chart ${chartId} not found or not initialized`);
                return;
            }

            const modal = document.getElementById('chartModal');
            const modalTitle = document.getElementById('modalChartTitle');
            const modalCanvas = document.getElementById('modalChart');
            // Set the modal title with icon
            let iconHtml = '';
            if (chartId === 'dbConnectionChart') iconHtml = '<i class="fas fa-database icon"></i> ';
            else if (chartId === 'siteResourcesChart') iconHtml = '<i class="fas fa-microchip icon"></i> ';
            else if (chartId === 'serverResourcesChart') iconHtml = '<i class="fas fa-server icon"></i> ';
            else if (chartId === 'activeCircuitsChart') iconHtml = '<i class="fas fa-project-diagram icon"></i> ';
            else if (chartId === 'responseTimeChart') iconHtml = '<i class="fas fa-clock icon"></i> ';
            modalTitle.innerHTML = iconHtml + title;
            // Create a new chart instance for the modal
            if (modalChart) {
                modalChart.destroy();
            }
            try {
                // Clone the original chart's data and options
                // Handle multiple y-axes and datasets
                const datasets = originalChart.data.datasets.map(ds => ({
                    ...ds,
                    data: [...ds.data],
                    pointRadius: 2,
                    borderWidth: 2
                }));
                // Clone all y-axes
                const scales = {};
                for (const [key, axis] of Object.entries(originalChart.options.scales)) {
                    scales[key] = { ...axis };
                }
                const chartConfig = {
                    type: 'line',
                    data: {
                        labels: [...originalChart.data.labels],
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: scales,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: { display: true, text: title, padding: { top: 10, bottom: 10 } },
                            tooltip: { mode: 'index', intersect: false }
                        }
                    }
                };
                // Create the new chart
                modalChart = new Chart(modalCanvas, chartConfig);
                // Show the modal
                modal.classList.add('active');
                // Prevent body scrolling when modal is open
                document.body.style.overflow = 'hidden';
            } catch (error) {
                console.error('Error expanding chart:', error);
                // Clean up if there's an error
                if (modalChart) {
                    modalChart.destroy();
                    modalChart = null;
                }
            }
        }

        function closeChartModal() {
            const modal = document.getElementById('chartModal');
            modal.classList.remove('active');
            
            // Re-enable body scrolling
            document.body.style.overflow = '';
            
            // Destroy the modal chart
            if (modalChart) {
                modalChart.destroy();
                modalChart = null;
            }
        }

        // Close modal when clicking outside
        document.getElementById('chartModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeChartModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('chartModal').classList.contains('active')) {
                closeChartModal();
            }
        });

        // Theme toggling
        function toggleTheme() {
            const newTheme = getCurrentTheme() === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            const newColors = chartColors[newTheme];
            const gridColor = newTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            // Update colors and grid for all charts
            charts.dbConnectionChart.data.datasets[0].borderColor = newColors.hostMemory;
            charts.dbConnectionChart.data.datasets[1].borderColor = newColors.sqlMemory;
            charts.dbConnectionChart.data.datasets[2].borderColor = newColors.hostCpu;
            charts.dbConnectionChart.data.datasets[3].borderColor = newColors.sqlCpu;
            charts.siteResourcesChart.data.datasets[0].borderColor = newColors.processCpu;
            charts.siteResourcesChart.data.datasets[1].borderColor = newColors.processMemory;
            charts.serverResourcesChart.data.datasets[0].borderColor = newColors.processorTime;
            charts.serverResourcesChart.data.datasets[1].borderColor = newColors.availableMemory;
            // Update grid colors
            allCharts.forEach(chart => {
                chart.options.scales.y.grid.color = gridColor;
                chart.update();
            });
        }

        // Set initial theme
        document.documentElement.setAttribute('data-theme', currentTheme);

        // Handle window resize to make charts responsive
        function handleResize() {
            console.log('Handling resize...', Object.keys(charts));
            
            // Simple and reliable resize approach
            Object.entries(charts).forEach(([key, chart]) => {
                if (chart && typeof chart.resize === 'function') {
                    try {
                        console.log(`Resizing chart: ${key}`);
                        
                        // Reset any manual canvas sizing first
                        if (chart.canvas) {
                            chart.canvas.style.width = '';
                            chart.canvas.style.height = '';
                        }
                        
                        // Let Chart.js handle the resize naturally
                        chart.resize();
                        chart.update('none');
                        
                    } catch (error) {
                        console.error(`Error resizing chart ${key}:`, error);
                    }
                }
            });
            
            // Also resize modal chart if it exists
            if (modalChart && typeof modalChart.resize === 'function') {
                try {
                    console.log('Resizing modal chart');
                    
                    // Reset any manual canvas sizing first
                    if (modalChart.canvas) {
                        modalChart.canvas.style.width = '';
                        modalChart.canvas.style.height = '';
                    }
                    
                    modalChart.resize();
                    modalChart.update('none');
                } catch (error) {
                    console.error('Error resizing modal chart:', error);
                }
            }
            
            console.log('Resize handling completed');
        }

        // Add resize event listener with debouncing to improve performance
        let resizeTimeout;
        window.addEventListener('resize', function() {
            console.log('Window resize event triggered');
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleResize, 250); // Increased delay for better performance
        });

        // Also trigger resize on orientation change for mobile devices
        window.addEventListener('orientationchange', function() {
            console.log('Orientation change event triggered');
            setTimeout(handleResize, 500); // Longer delay for orientation changes
        });

        // Alternative approach: use ResizeObserver if available (but only for container-fluid to avoid excessive calls)
        if (window.ResizeObserver) {
            const resizeObserver = new ResizeObserver(entries => {
                console.log('ResizeObserver triggered for', entries.length, 'elements');
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(handleResize, 150);
            });
            
            // Only observe the main container to reduce excessive calls
            const mainContainer = document.querySelector('.container-fluid');
            if (mainContainer) {
                resizeObserver.observe(mainContainer);
            }
        }
    </script>
</body>
</html>
